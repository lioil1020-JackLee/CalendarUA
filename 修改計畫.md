# CalendarUA 修改計畫（完整版：先 UI 對齊，再做 OPC UA Tag）

> 目標：先把目前 PySide6 介面調整到與 `swx.pdf`（ICONICS GENESIS64 v10.97.2 擷取圖）一致，再進入 OPC UA Tag 結構化整合。
>
> 重要前提：`swx.pdf` 為純圖片頁（無文字層），已輸出參考圖到 `docs/swx_refs_auto/page_01.png` ~ `page_19.png`，本計畫採「影像規格化」方式執行。

---

## 0. 本版補強重點（針對你提出的缺口）

本版計畫新增並明確定義：
1. 右鍵選單規格（保留/移除/替代入口）。
2. 行事曆與日期選取互動規格（含移除 Preview 後替代方式）。
3. 下拉選單規格（資料來源、預設值、禁用條件、儲存行為）。
4. 左上角功能區規格（主窗左上 actions/menu/toolbar 重新編排）。
5. 資料庫是否需異動（本階段/下階段拆開）。
6. RRULE 是否需修改（結論：UI 對齊階段不改語法，僅改入口）。

---

## 1. 範圍與不變更項目

### 1.1 本階段「會做」
1. UI 架構調整成與 PDF 一致：**移除 Tab `Weekly`、`Preview`、`Runtime`**。
2. 互動規格完整化：按鈕、右鍵、日期、下拉、狀態回饋。
3. 主畫面操作收斂：避免同功能分散在多入口且語意不一致。

### 1.2 本階段「不做」
1. 不改核心排程運算邏輯（`core/rrule_parser.py`、`core/schedule_resolver.py` 規則本體不改）。
2. 不改 OPC UA 通訊核心流程（`core/opc_handler.py`）。
3. 不刪除歷史資料表（例如 `runtime_override`）以避免破壞舊資料相容性。

---

## 2. 現況盤點（帶影響分析）

### 2.1 UI 主結構
- 主入口：`CalendarUA.py`
- 目前 Tab：`General`、`Weekly`、`Holidays`、`Exceptions`、`Preview`、`Runtime`
- 目標 Tab：`General`、`Holidays`、`Exceptions`

### 2.2 移除三個 Tab 的程式影響範圍
1. `Preview` 影響最大：
   - 日期選擇：`preview_date_edit`
   - 視圖切換：`set_view_mode`, `go_today`, `go_previous_period`, `go_next_period`
   - 右鍵事件：`on_canvas_context_action`（Open/Delete/New/Copy/Cut/Paste/Refresh/Apply/Time Scale）
2. `Weekly` 影響中等：
   - `weekly_panel` 載入與 `schedule_selected` signal
   - 週視圖導向的編輯入口
3. `Runtime` 影響中等：
   - `runtime_panel` 載入與 `override_changed` signal
   - `runtime_override` 覆寫 UI 入口

### 2.3 PDF 基礎分析結論
1. 共 19 頁、A4 直式，頁面尺寸一致。
2. 圖面由截圖組成，無法直接抽文案；需逐頁標註互動元件。
3. 可行做法：先建立「頁碼→元件→程式碼」映射，再分批實作。

---

## 3. 互動規格（完整定義）

## 3.1 右鍵選單規格

### A. 原本 Preview/Canvas 右鍵（將移除）
原有動作：`Open/Delete/New Event/Copy/Cut/Paste/Refresh Schedule/Apply Schedule/Time Scale`

### B. 移除後替代原則
1. **不保留隱性右鍵行為**：若畫面沒有對應元件，功能要移到可見按鈕或列操作。
2. 功能收斂：
   - `Open/Edit` → 由「編輯」主按鈕或雙擊列觸發。
   - `Delete` → 由「刪除」主按鈕觸發（保留確認視窗）。
   - `Refresh/Apply` → 保留在主工具列。
   - `Copy/Cut/Paste/Time Scale` → 本階段移除（若 PDF 無對應）。

### C. 保留頁面的右鍵策略（General/Holidays/Exceptions）
1. 若 PDF 有明確右鍵選單，才新增。
2. 若 PDF 無右鍵示意，採「顯式按鈕優先」，不新增右鍵。

**驗收標準**：移除 Preview 後，不存在 orphan action（可觸發但沒有可見入口或狀態）。

---

## 3.2 日期選擇規格

1. **主畫面**
   - 移除 Preview 後，主畫面不再提供 Day/Week/Month 日期導航。
2. **Holidays**
   - 日期輸入統一用 `QDateEdit`（彈出行事曆）
   - 格式固定 `yyyy-MM-dd`
3. **Exceptions**
   - occurrence 日期使用 `QDateEdit`
   - override 起訖使用 `QDateTimeEdit`
4. **Recurrence Dialog（仍保留）**
   - 起訖日期與時間由原對話框控制，不在主畫面直接編輯。

**驗收標準**：所有日期輸入點都具備一致格式、合法範圍檢查、錯誤訊息。

---

## 3.3 下拉選單規格（ComboBox）

### A. `General.output_type`
1. 預設值：`OPC UA Write`
2. 來源：固定清單（後續可改設定檔驅動）
3. 行為：變更即標記未儲存；按儲存後落 DB

### B. `Exceptions.schedule`
1. 來源：啟用中的排程（或全部排程，依 PDF 規格定案）
2. 顯示：`[id] task_name (rrule摘要)`
3. 行為：無可選項時，新增例外按鈕需禁用並提示

### C. `Recurrence.duration` / 其他 combo
1. 若 PDF 指定固定選單：改為不可編輯。
2. 若 PDF 顯示可輸入：保留 editable 並加格式驗證。
3. 所有 combo 需定義：預設值、是否可輸入、異常值處理。

**驗收標準**：每個下拉都有「來源/預設/儲存時機/禁用條件」四要素。

---

## 3.4 左上角功能區（主窗）規格

> 你特別提到左上角，這裡明確拆成 menu 與 toolbar。

1. `File`：保留 `New/Refresh/Apply/Load Profile/Save Profile/Exit`（依 PDF 再微調命名）
2. `View`：移除 Day/Week/Month/Today（因 Preview 移除）
3. `Edit`：保留 `Edit/Delete/Manage Categories`
4. Toolbar：保留 `New/Edit/Delete/Refresh/Apply/Categories`
5. 若 PDF 左上功能更精簡，則採「先減法」：不必要先隱藏、後刪除。

**驗收標準**：左上操作與可見主內容一致，不出現「操作存在但畫面已不存在」。

---

## 4. DB 與資料結構策略

## 4.1 UI 階段資料庫是否要改？

### 結論
1. **可先不改 schema**（建議）：
   - `runtime_override` 保留，不在 UI 顯示即可。
   - `schedules`、`general_settings`、`schedule_exceptions`、`holiday_*` 皆可沿用。
2. 僅做「程式層停用」：
   - 不再呼叫 runtime UI 相關讀寫流程。

### 何時需要 DB 異動
1. 第二階段要把 OPC 預設放入 General 時，才擴充 `general_settings` 欄位。
2. 若確定永久移除 runtime override，才做 migration（非本階段必做）。

---

## 4.2 建議 migration 規劃（第二階段）

1. `general_settings` 新增：
   - `default_opc_url`
   - `default_opc_security_policy`
   - `default_opc_security_mode`
   - `default_opc_username`
   - `default_opc_password`
   - `default_opc_timeout`
   - `default_opc_write_timeout`
2. `schedules` 保持原欄位，走「空值繼承全域」策略。
3. migration 需具備 backward compatibility（舊 DB 可啟動、欄位自動補齊）。

---

## 5. RRULE 影響評估與決策

## 5.1 RRULE 是否要改結構？

### 結論
**本階段不改 RRULE 語法結構。**

理由：
1. Tab 移除屬 UI 架構調整，非規則引擎重寫。
2. 現有 `RRuleParser` / `schedule_resolver` 與 DB `rrule_str` 已可運作。
3. 同步改 RRULE 會擴大風險，不符合先 UI 對齊目標。

## 5.2 會調整的只有入口
1. 原本由 `Weekly` 快速建立 `FREQ=WEEKLY` 的入口移除。
2. 改由統一的排程編輯/週期對話框建立與修改 RRULE。
3. 仍需支援既有 `FREQ=WEEKLY` 資料讀寫與執行。

**驗收標準**：既有資料庫中的 RRULE 不需轉換即可正常執行。

---

## 6. 實作步驟（一步一步）

## Step 1：先做 Tab 與入口清理
1. 移除 `Weekly/Preview/Runtime` 的 `addTab`。
2. 清理相關 import、signal-slot、load hooks。
3. 清理 `View` menu 的 Day/Week/Month/Today actions。
4. 保留對應檔案但不掛載進主 UI。

## Step 2：建立「互動規格表」
1. 新增 `docs/ui_interaction_spec.md`。
2. 每個畫面定義：
   - 觸發方式（點擊/雙擊/右鍵）
   - 前置條件（enable/disable）
   - 成功結果
   - 失敗訊息

## Step 3：建立「PDF 對照表」
1. 新增 `docs/ui_swx_mapping.md`，以 `docs/swx_refs_auto` 作底稿。
2. 每頁標註：元件、文案、互動、對應程式碼。

## Step 4：實作 General/Holidays/Exceptions 對齊
1. 先對齊結構（區塊、按鈕位置、欄位順序）。
2. 再對齊文案與狀態回饋。
3. 最後補齊缺失互動（但不新增業務邏輯）。

## Step 5：左上角功能區重整
1. 對齊 PDF 的 menu/toolbar 顯示。
2. 移除與已刪畫面綁定的動作。
3. 核對快捷鍵是否衝突。

## Step 6：資料層保守驗證
1. 驗證不改 DB schema 仍可正常啟動與操作。
2. 驗證 runtime_override 即使無 UI 入口仍不影響排程主流程。

## Step 7：回歸測試
1. General/Holidays/Exceptions 主流程點測。
2. 新增/編輯/刪除/刷新/套用全測。
3. 舊資料庫載入與 RRULE 執行測試。

---

## 7. 檔案級落地順序

1. `CalendarUA.py`（Tab、menu、toolbar、actions、signals）
2. `ui/general_panel.py`
3. `ui/holidays_panel.py`
4. `ui/exceptions_panel.py`
5. `ui/recurrence_dialog.py`（若 PDF 對話框有明確差異）
6. `database/sqlite_manager.py`（僅必要時，先不動 schema）

---

## 8. 交付里程碑（Milestone）

### M1：架構清理完成
- 主 UI 只剩三個 Tab。
- 不再有 Preview/Weekly/Runtime 殘留入口。

### M2：互動規格完成
- `docs/ui_interaction_spec.md` 完整定義所有互動。

### M3：視覺對照完成
- 19 頁對照表完成，並附 before/after。

### M4：穩定驗收完成
- 主流程可操作、無致命回歸、RRULE 不受破壞。

---

## 9. 風險與對策（強化版）

1. **PDF 為圖片，互動語意可能解讀錯誤**
   - 對策：每頁建立「假設欄位」與「驗證欄位」，避免主觀推斷。

2. **Tab 移除後遺留 dead code / orphan action**
   - 對策：建立清單逐項勾選（import、signal、handler、menu、toolbar、shortcut）。

3. **不改 DB schema 但 UI 行為變更，可能出現資料孤島**
   - 對策：標註「停用但保留」資料表，於第二階段統一清理。

4. **RRULE 入口改動導致使用者誤以為規則變了**
   - 對策：在 UI 文案加註「規則不變、入口調整」。

---

## 10. 第二階段預告：OPC UA Tag 放到 General 或其他頁

1. 先做 IA：區分全域預設與排程覆寫。
2. 再做 DB migration：新增 general defaults 欄位。
3. UI 顯示值來源：`全域` / `覆寫`。
4. 驗收：只填 General、部分覆寫、切換 Profile 三大情境。

---

## 11. Definition of Done（UI 階段）

- [ ] 主 UI 僅保留 `General`、`Holidays`、`Exceptions`。
- [ ] 右鍵/日期/下拉/左上功能都有書面規格與實作一致。
- [ ] 所有可見按鈕都有成功/失敗回饋，不存在無反應。
- [ ] 不改 RRULE 結構仍可正常載入與執行舊資料。
- [ ] 不改 DB schema 仍可正常運行（或若有改動，具完整 migration）。
- [ ] `docs/ui_interaction_spec.md` 與 `docs/ui_swx_mapping.md` 可追溯每一頁需求。
